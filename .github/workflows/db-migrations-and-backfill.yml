name: Database migrations & stock backfill

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_name:
        description: "Identifier for the apply run"
        required: false
        default: "manual-apply"
      batch_limit:
        description: "Batch size (defaults to 1000)"
        required: false
        default: "1000"
      apply:
        description: "Confirm apply run"
        required: true
        default: "false"

jobs:
  migration-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: supabase/postgres:15.1.1.56
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Apply migrations to ephemeral database
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
        run: |
          set -euo pipefail
          for file in db/migrations/*.sql; do
            echo "Running $file"
            psql "$DATABASE_URL" -f "$file"
          done
      - name: Install dependencies
        run: npm install
      - name: Lint project
        run: npm run lint

  backfill-dry-run:
    if: github.event_name == 'pull_request'
    needs: migration-check
    runs-on: ubuntu-latest
    services:
      postgres:
        image: supabase/postgres:15.1.1.56
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Apply migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
        run: |
          set -euo pipefail
          for file in db/migrations/*.sql; do
            psql "$DATABASE_URL" -f "$file"
          done
      - name: Install dependencies
        run: npm install
      - name: Execute dry-run backfill
        id: backfill
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
        run: |
          set -euo pipefail
          OUTPUT=$(node scripts/run_backfill.js --run-name "ci-dry-${GITHUB_RUN_ID}" --batch 500)
          echo "$OUTPUT"
          RUN_ID=$(echo "$OUTPUT" | grep 'RUN_ID=' | tail -1 | cut -d'=' -f2)
          if [ -z "$RUN_ID" ]; then
            echo "Failed to parse run id" >&2
            exit 1
          fi
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
          psql "$DATABASE_URL" -c "\copy (SELECT inventory_item_id, location, previous_quantity, new_quantity, computed_at FROM stock_backfill_diffs WHERE backfill_run_id = '$RUN_ID' ORDER BY computed_at DESC LIMIT 200) TO 'stock_backfill_diffs.csv' CSV HEADER"
      - name: Upload diff sample
        uses: actions/upload-artifact@v4
        with:
          name: stock-backfill-diffs
          path: stock_backfill_diffs.csv

  apply-migrations:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Apply migrations to staging
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL_STAGING }}
        run: |
          set -euo pipefail
          if [ -z "$DATABASE_URL" ]; then
            echo "SUPABASE_DB_URL_STAGING secret is not configured" >&2
            exit 1
          fi
          for file in db/migrations/*.sql; do
            psql "$DATABASE_URL" -f "$file"
          done
      - name: Apply migrations to production
        if: secrets.SUPABASE_DB_URL_PROD != ''
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL_PROD }}
        run: |
          set -euo pipefail
          for file in db/migrations/*.sql; do
            psql "$DATABASE_URL" -f "$file"
          done

  manual-backfill-apply:
    if: github.event_name == 'workflow_dispatch' && inputs.apply == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - name: Install dependencies
        run: npm install
      - name: Apply stock backfill
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL_PROD }}
        run: |
          set -euo pipefail
          if [ -z "$DATABASE_URL" ]; then
            echo "SUPABASE_DB_URL_PROD secret is required for apply runs" >&2
            exit 1
          fi
          node scripts/run_backfill.js --apply --run-name "${{ inputs.run_name }}" --batch "${{ inputs.batch_limit }}"
